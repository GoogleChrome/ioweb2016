<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<script src="../bower_components/propel-web-push/dist/propel-client.js"></script>
<!--
The `<io-notification-widget>` element renders the notification toggle UI.
-->

<dom-module id="io-notification-widget">
  <template>
    <div class="card-content">
      <h4>Notifications</h4>
      <iron-pages id="pages" selected="0">
        <div>
          <iron-label horizontal layout center>
            <paper-checkbox checked="{{checked}}" disabled="{{disabled}}">
            </paper-checkbox>
            <b>I want to receive notifications from the Google I/O 2016 web app.</b>
          </iron-label>
          <p>If this option is deselected, I understand I won't be notified when:</p>
          <ul>
            <li>I/O is about to start</li>
            <li>Events added to My Schedule are about to start</li>
            <li>Videos of sessions added to My Schedule are available</li>
          </ul>
          <p class="settings-note"><b>Note</b>: Notifications are activated per device. To receive notifications on multiple devices, sign in on each device, enable notifications, and make sure you're online. However, turning off notifications on one device will turn them off on all devices.</p>
        </div>
        <div>
          The permission required for notifications has been denied. If you want to enable this feature you will need to change the permission setting.
          <br/>
          <a href="permissions" target="_blank">Learn how</a>.
        </div>
      </iron-pages>
    </div>
  </template>

  <script>
  (function() {
    "use strict";

    // Wait for the ServiceWorkerRegistration and IOFirebase modules to be loaded
    document.addEventListener('DOMContentLoaded', function() {
      // If the browser doesn't support push then we don't even have to instantiate the element
      if (goog.propel.PropelClient.supported()) {
        const propel = new goog.propel.PropelClient(IOWA.ServiceWorkerRegistration.URL, IOWA.ServiceWorkerRegistration.SCOPE);

        Polymer({

          is: 'io-notification-widget',

          properties: {
            checked: {
              type: Boolean,
              observer: '_checkedChanged'
            },
            disabled: {
              type: Boolean,
              value: true
            },
            autoSubscribe: {
              type: Boolean,
              value: true
            }
          },

          attached: function() {
            propel.addEventListener('statuschange', status => {
              this._statusChanged(status)
            });
            IOWA.IOFirebase.registerToNotificationUpdates(value => {
              this._firebaseChanged(value)
            });
            document.addEventListener('signin-change', function(e) {
              if (!e.detail.user) {
                // We logged out, so unsubscribe
                propel.unsubscribe();
              }
            });
          },

          subscribeIfAble: function() {
            if (this.autoSubscribe) {
              return propel.subscribe()
                .then((sub) => !!sub)
                .catch((err) => false);
            }
            return Promise.resolve(false);
          },

          _firebaseChanged: function(value) {
            // Feature turned off on another client, so turn off here too
            if (!value) {
              this.checked = false;
              propel.unsubscribe();
            } else {
              Promise.all([
                goog.propel.PropelClient.getPermissionState(),
                propel.getSubscription()
              ]).then((perm, sub) => {
                if (perm.state === 'granted' && !sub) {
                  // 1. The global notification setting is on
                  // 2. This client already has permission for notifications
                  // 3. There is no current local subscription
                  // So we're going to subscribe locally. This state is most
                  // likely to come about because the user signed out on this
                  // device after they enabled notifications.
                  propel.subscribe()
                    .catch(IOWA.Util.reportError);;
                }
              });
            }
          },

          _statusChanged: function(status) {
            if (status.permissionState === 'granted') {
              this.$.pages.select(0);
              this.checked = status.isSubscribed;
              this.disabled = false;
              IOWA.IOFirebase.setNotificationsEnabled(status.isSubscribed);
              if (status.isSubscribed) {
                IOWA.IOFirebase.addPushSubscription(status.currentSubscription);
              } else {
                // TODO(mscales): Remove the exisiting subscription from FB
              }
            } else if (status.permissionState === 'denied') {
              this.$.pages.select(1);
              // Were we actually trying to turn notifications on
              if (this.checked) {
                IOWA.Elements.Toast.showMessage('Please update your notification permissions', null, 'Learn how', () => window.open('permissions', '_blank'));
              }
              this.disabled = true;
              this.checked = false;
              this.autoSubscribe = false;
            } else {
              // permission dialog was dismissed without answering, can still prompt again
              this.$.pages.select(0);
              this.disabled = false;
              this.checked = false;
            }
          },

          _checkedChanged: function() {
            if (this.disabled) {
              return;
            }

            this.disabled = true;
            this.autoSubscribe = this.checked;
            const action = this.checked ? propel.subscribe() : propel.unsubscribe();

            // TODO(mscales): Better handling of errors
            return action.catch(IOWA.Util.reportError);
          }
        });
      } else {
        document.body.classList.add('nosupport-notifications');
      }
    });
  })();
  </script>
</dom-module>

